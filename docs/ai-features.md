# AI 功能详解

## AI 系统概述

RuaBot 深度集成了 AI 功能，提供了完整的智能对话系统。AI 系统支持多种 LLM 模型，具备表达学习、智能回复、知识管理、记忆系统等核心功能。

### 核心特性

- **多模型支持**: 支持 OpenAI、MCP 等多种 LLM 模型
- **表达学习**: 自动学习用户的说话风格和表达习惯
- **智能回复**: 生成符合群聊风格的智能回复
- **黑话理解**: 识别和理解群聊中的黑话、俚语
- **知识管理**: 支持知识图谱的构建和管理
- **记忆系统**: 维护对话历史和上下文记忆
- **持续学习**: 不断优化表达方式和回复质量

## 系统架构

### AI 模块组成

```
AI 模块
├── 模型管理 (ModelManager)
│   ├── 模型配置
│   ├── 模型切换
│   └── 模型调用
├── 消息处理 (MessageHandler)
│   ├── 消息预处理
│   ├── 消息过滤
│   └── 消息转换
├── 回复生成 (Replyer)
│   ├── 上下文构建
│   ├── AI 调用
│   └── 回复优化
├── 学习系统
│   ├── 表达学习 (ExpressionLearner)
│   ├── 风格适配 (ExpressionSelector)
│   └── 黑话理解 (JargonMiner)
├── 知识管理
│   ├── 知识提取 (OpenIE)
│   ├── 知识存储 (KGStorage)
│   └── 知识检索 (KGManager)
└── 记忆管理
    ├── 记忆存储
    ├── 记忆检索
    └── 记忆更新
```

## 配置说明

### 全局配置

在 Web UI 或通过 API 配置全局 AI 设置：

```json
{
  "enabled": true,
  "model_uuid": "model-uuid",
  "preset_uuid": "preset-uuid",
  "config": {
    "trigger_command": "@bot",
    "max_tokens": 2000,
    "temperature": 0.7
  }
}
```

### 群组配置

为特定群组配置 AI 行为：

```json
{
  "config_type": "group",
  "target_id": "123456789",
  "enabled": true,
  "model_uuid": "model-uuid",
  "preset_uuid": "preset-uuid",
  "config": {
    "trigger_command": "",
    "reply_probability": 0.3
  }
}
```

### 用户配置

为特定用户配置 AI 行为：

```json
{
  "config_type": "user",
  "target_id": "987654321",
  "enabled": true,
  "model_uuid": "model-uuid",
  "preset_uuid": "preset-uuid"
}
```

### 配置继承

- 群组配置继承全局配置
- 用户配置继承群组配置和全局配置
- 子级配置会覆盖父级配置

## 模型管理

### 支持的模型

#### OpenAI 模型

- GPT-3.5-turbo
- GPT-4
- GPT-4-turbo
- 其他 OpenAI 兼容模型

#### MCP 模型

通过 MCP (Model Context Protocol) 协议支持多种模型。

### 添加模型

通过 Web UI 或 API 添加新模型：

```python
{
  "name": "模型名称",
  "type": "openai",
  "api_key": "your-api-key",
  "base_url": "https://api.openai.com/v1",
  "model": "gpt-4"
}
```

### 模型切换

可以在运行时切换模型，切换后立即生效。

## 预设管理

### 创建预设

预设定义了 AI 的行为风格和提示词：

```json
{
  "name": "预设名称",
  "system_prompt": "你是一个友好的助手...",
  "temperature": 0.7,
  "max_tokens": 2000
}
```

### 预设应用

可以为不同场景创建不同的预设：
- 日常聊天预设
- 技术问答预设
- 娱乐互动预设

## 表达学习

### 工作原理

表达学习系统会分析群聊中的消息，提取用户的表达风格：

1. **消息收集**: 收集群聊中的消息
2. **风格提取**: 分析消息的语言风格、用词习惯
3. **模式识别**: 识别常见的表达模式
4. **风格适配**: 在生成回复时应用学习到的风格

### 学习配置

```json
{
  "learning_enabled": true,
  "learning_rate": 0.1,
  "min_samples": 10,
  "update_interval": 3600
}
```

### 风格适配

系统会自动选择最合适的表达风格：
- 根据群组风格选择
- 根据对话上下文选择
- 根据用户偏好选择

## 智能回复

### 回复生成流程

```
消息接收
    │
    ▼
消息预处理
    │
    ▼
记忆检索
    │
    ├──► 群组记忆
    ├──► 用户记忆
    └──► 会话记忆
    │
    ▼
上下文构建
    │
    ├──► 系统提示词
    ├──► 对话历史
    ├──► 相关知识
    └──► 风格提示
    │
    ▼
AI 模型调用
    │
    ▼
回复后处理
    │
    ├──► 风格适配
    ├──► 内容优化
    └──► 表情选择
    │
    ▼
回复发送
```

### 触发方式

#### 命令触发

使用特定命令触发 AI 回复：

```
@bot 你好
```

#### 概率触发

根据配置的概率自动回复：

```json
{
  "reply_probability": 0.3
}
```

#### 关键词触发

检测到特定关键词时触发：

```json
{
  "trigger_keywords": ["问题", "帮助", "怎么"]
}
```

### 回复优化

系统会对生成的回复进行优化：

- **风格适配**: 应用学习到的表达风格
- **长度控制**: 控制回复长度
- **内容过滤**: 过滤不当内容
- **表情添加**: 自动添加合适的表情

## 黑话理解

### 功能说明

黑话理解系统能够识别和理解群聊中的黑话、俚语：

1. **黑话挖掘**: 自动挖掘群聊中的黑话
2. **黑话学习**: 学习黑话的含义和用法
3. **黑话理解**: 在对话中理解和使用黑话

### 配置

```json
{
  "jargon_mining_enabled": true,
  "jargon_threshold": 0.5,
  "update_interval": 7200
}
```

## 知识管理

### 知识图谱

系统支持构建知识图谱来存储和管理知识：

#### 知识提取

从对话中自动提取知识：

```python
{
  "entity": "实体",
  "relation": "关系",
  "target": "目标实体"
}
```

#### 知识存储

知识存储在向量数据库中，支持快速检索。

#### 知识检索

在生成回复时检索相关知识：

```python
{
  "query": "查询内容",
  "top_k": 5
}
```

### 知识更新

知识图谱会持续更新：
- 自动从对话中提取新知识
- 定期更新知识关系
- 清理过时知识

## 记忆管理

### 记忆类型

#### 群组记忆

存储群组级别的对话历史：

```python
{
  "memory_type": "group",
  "target_id": "123456789",
  "messages": [...],
  "message_count": 100
}
```

#### 用户记忆

存储用户级别的对话历史：

```python
{
  "memory_type": "user",
  "target_id": "987654321",
  "messages": [...],
  "message_count": 50
}
```

#### 会话记忆

存储当前会话的上下文：

```python
{
  "memory_type": "session",
  "target_id": "session-id",
  "messages": [...]
}
```

### 记忆检索

在生成回复时检索相关记忆：

```python
{
  "memory_type": "group",
  "target_id": "123456789",
  "query": "查询内容",
  "limit": 10
}
```

### 记忆更新

记忆会随着对话自动更新：
- 新消息添加到记忆
- 定期清理旧记忆
- 压缩长记忆

## 高级功能

### Dream 系统

Dream 系统是一个高级的 AI 功能，支持：

- **自主思考**: AI 可以自主思考和分析
- **任务规划**: 规划复杂的任务
- **工具使用**: 使用各种工具完成任务

#### 配置

```json
{
  "dream_enabled": true,
  "dream_interval": 3600,
  "max_dream_steps": 10
}
```

### 频率控制

控制 AI 回复的频率，避免过度回复：

```json
{
  "frequency_control": {
    "max_replies_per_minute": 5,
    "cooldown_period": 60
  }
}
```

### 群组画像

系统会为每个群组生成画像：

```json
{
  "group_id": "123456789",
  "profile": {
    "topic": "技术讨论",
    "style": "正式",
    "activity": "高"
  }
}
```

### 用户画像

系统会为每个用户生成画像：

```json
{
  "user_id": "987654321",
  "profile": {
    "interests": ["编程", "游戏"],
    "style": "轻松",
    "activity": "中"
  }
}
```

## 最佳实践

### 1. 模型选择

- 日常聊天使用 GPT-3.5-turbo
- 复杂任务使用 GPT-4
- 根据需求选择合适的模型

### 2. 预设配置

- 为不同场景创建不同预设
- 定期优化预设提示词
- 测试预设效果

### 3. 记忆管理

- 定期清理旧记忆
- 控制记忆大小
- 优化记忆检索

### 4. 频率控制

- 设置合理的回复频率
- 避免过度回复
- 根据群组活跃度调整

### 5. 学习优化

- 定期检查学习效果
- 调整学习参数
- 清理无效学习数据

## 性能优化

### 缓存机制

- 模型响应缓存
- 记忆检索缓存
- 知识检索缓存

### 异步处理

所有 AI 操作都是异步的，不会阻塞主线程。

### 批量处理

支持批量处理多个请求，提高效率。

## 监控和调试

### 日志查看

查看 AI 相关的日志：

```bash
tail -f logs/onebot_framework.log | grep AI
```

### 性能监控

通过 Web UI 监控 AI 性能：
- 响应时间
- 调用次数
- 错误率

### 调试模式

启用调试模式查看详细信息：

```json
{
  "debug": true,
  "log_level": "DEBUG"
}
```

## 常见问题

### 1. AI 不回复

**问题**: 配置了 AI 但没有回复。

**解决方案**:
- 检查 AI 是否启用
- 检查触发条件是否正确
- 查看日志确认是否有错误
- 检查模型配置是否正确

### 2. 回复质量不佳

**问题**: AI 回复质量不理想。

**解决方案**:
- 优化系统提示词
- 调整温度参数
- 增加上下文记忆
- 使用更好的模型

### 3. 记忆占用过大

**问题**: 记忆数据占用过多空间。

**解决方案**:
- 定期清理旧记忆
- 限制记忆长度
- 压缩记忆数据

### 4. 学习效果不明显

**问题**: 表达学习效果不明显。

**解决方案**:
- 增加学习样本
- 调整学习参数
- 检查学习数据质量

## 参考资源

- [模型管理 API](../src/ai/model_manager.py)
- [回复生成器](../src/ai/replyer.py)
- [表达学习器](../src/ai/expression_learner.py)
- [知识管理器](../src/ai/knowledge/)

---

更多详细信息请参考相关 API 文档和源码。
