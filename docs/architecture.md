# 系统架构与逻辑原理

## 整体架构

RuaBot 采用分层架构设计，各层职责清晰，便于维护和扩展。

### 架构层次

```
┌─────────────────────────────────────────┐
│         表示层 (Presentation)           │
│  ┌──────────────┐  ┌──────────────┐   │
│  │   Web UI     │  │   REST API   │   │
│  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────┘
                  │
┌─────────────────────────────────────────┐
│         应用层 (Application)             │
│  ┌──────────────┐  ┌──────────────┐   │
│  │   Router     │  │   Security   │   │
│  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────┘
                  │
┌─────────────────────────────────────────┐
│         业务层 (Business)                │
│  ┌──────────────┐  ┌──────────────┐   │
│  │   Plugins    │  │      AI      │   │
│  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐   │
│  │   Protocol   │  │   EventBus   │   │
│  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────┘
                  │
┌─────────────────────────────────────────┐
│         核心层 (Core)                    │
│  ┌──────────────┐  ┌──────────────┐   │
│  │    Config    │  │   Database   │   │
│  └──────────────┘  └──────────────┘   │
│  ┌──────────────┐  ┌──────────────┐   │
│  │    Logger    │  │   Storage    │   │
│  └──────────────┘  └──────────────┘   │
└─────────────────────────────────────────┘
                  │
┌─────────────────────────────────────────┐
│         协议层 (Protocol)                │
│         OneBot v11 Protocol             │
└─────────────────────────────────────────┘
```

## 核心模块说明

### 1. Core 模块

核心模块提供基础服务，是整个框架的基石。

#### 配置管理 (Config)

- **功能**: 统一的配置管理系统
- **特性**: 
  - 支持 TOML 配置文件
  - 支持环境变量覆盖
  - 支持热重载
  - 类型安全的配置访问
- **实现**: `src/core/config.py`

#### 数据库 (Database)

- **功能**: 数据持久化服务
- **特性**:
  - 异步数据库操作
  - SQLAlchemy ORM
  - 支持 SQLite
  - 数据库迁移
- **实现**: `src/core/database.py`

#### 日志系统 (Logger)

- **功能**: 分级日志记录
- **特性**:
  - 多级别日志 (DEBUG, INFO, WARNING, ERROR)
  - 文件日志和控制台日志
  - 日志轮转
  - 结构化日志
- **实现**: `src/core/logger.py`

#### 事件总线 (EventBus)

- **功能**: 事件发布和订阅机制
- **特性**:
  - 异步事件处理
  - 事件过滤
  - 事件优先级
  - 事件拦截
- **实现**: `src/core/event_bus.py`

#### 存储 (Storage)

- **功能**: 通用存储服务
- **特性**:
  - 键值存储
  - 插件数据隔离
  - 数据持久化
- **实现**: `src/core/storage.py`

### 2. Plugin 模块

插件系统是框架扩展性的核心。

#### 插件管理器 (PluginManager)

- **功能**: 插件的生命周期管理
- **特性**:
  - 插件加载和卸载
  - 插件热重载
  - 插件依赖管理
  - 插件配置管理
- **实现**: `src/plugins/manager.py`

#### 插件接口 (PluginInterface)

- **功能**: 标准化的插件接口
- **特性**:
  - 生命周期钩子
  - 事件处理接口
  - 能力注册接口
- **实现**: `src/plugins/interface.py`

#### 适配器系统 (Adapter)

- **功能**: 插件适配器管理
- **特性**:
  - 多种适配器类型
  - 插件加载适配
  - 运行时环境提供
- **实现**: `src/plugins/runtime/`

#### 能力注册 (CapabilityRegistry)

- **功能**: 插件能力注册和发现
- **特性**:
  - 能力注册
  - 能力查询
  - 能力依赖
- **实现**: `src/plugins/capability_registry.py`

#### 拦截器 (Interceptor)

- **功能**: 事件拦截和处理
- **特性**:
  - 事件拦截
  - 事件修改
  - 事件过滤
- **实现**: `src/plugins/interceptor.py`

### 3. AI 模块

AI 模块提供智能交互能力。

#### AI 管理器 (AIManager)

- **功能**: AI 功能统一管理
- **特性**:
  - AI 配置管理
  - 记忆管理
  - 模型切换
- **实现**: `src/ai/ai_manager.py`

#### 模型管理 (ModelManager)

- **功能**: LLM 模型管理
- **特性**:
  - 多模型支持
  - 模型切换
  - 模型配置
- **实现**: `src/ai/model_manager.py`

#### 消息处理 (MessageHandler)

- **功能**: 消息的预处理和后处理
- **特性**:
  - 消息解析
  - 消息过滤
  - 消息转换
- **实现**: `src/ai/message_handler.py`

#### 回复生成 (Replyer)

- **功能**: 智能回复生成
- **特性**:
  - 上下文理解
  - 风格适配
  - 回复优化
- **实现**: `src/ai/replyer.py`

#### 表达学习 (ExpressionLearner)

- **功能**: 学习用户的表达风格
- **特性**:
  - 风格提取
  - 模式识别
  - 风格适配
- **实现**: `src/ai/expression_learner.py`

#### 知识管理 (KnowledgeManager)

- **功能**: 知识图谱管理
- **特性**:
  - 知识提取
  - 知识存储
  - 知识检索
- **实现**: `src/ai/knowledge/`

#### 记忆管理 (MemoryRetrieval)

- **功能**: 对话记忆管理
- **特性**:
  - 记忆存储
  - 记忆检索
  - 记忆更新
- **实现**: `src/ai/memory_retrieval.py`

### 4. Protocol 模块

协议模块处理 OneBot 协议。

#### OneBot 协议 (OneBot)

- **功能**: OneBot v11 协议实现
- **特性**:
  - 消息接收
  - 消息发送
  - 事件处理
  - API 调用
- **实现**: `src/protocol/onebot.py`

#### 消息处理 (Message)

- **功能**: 消息的解析和构建
- **特性**:
  - 消息类型识别
  - 消息内容解析
  - 消息构建
- **实现**: `src/protocol/message.py`

#### 事件处理 (Events)

- **功能**: 事件的接收和分发
- **特性**:
  - 事件类型识别
  - 事件数据解析
  - 事件分发
- **实现**: `src/protocol/events.py`

### 5. Security 模块

安全模块提供安全功能。

#### 认证授权 (Auth)

- **功能**: 用户认证和授权
- **特性**:
  - 登录认证
  - Token 管理
  - 会话管理
- **实现**: `src/security/auth.py`

#### 权限管理 (Permissions)

- **功能**: 细粒度权限控制
- **特性**:
  - 权限定义
  - 权限检查
  - 权限继承
- **实现**: `src/security/permissions.py`

#### 访问控制 (AccessControl)

- **功能**: 访问控制列表管理
- **特性**:
  - ACL 定义
  - ACL 检查
  - ACL 更新
- **实现**: `src/security/access_control.py`

#### 审计日志 (Audit)

- **功能**: 安全审计日志
- **特性**:
  - 操作记录
  - 日志查询
  - 日志分析
- **实现**: `src/security/audit.py`

## 工作流程

### 消息处理流程

```
用户消息
    │
    ▼
OneBot 协议接收
    │
    ▼
事件总线发布消息事件
    │
    ├──► 拦截器处理
    │
    ├──► 插件订阅处理
    │
    └──► AI 模块处理
         │
         ├──► 消息记录
         ├──► 记忆检索
         ├──► 上下文构建
         ├──► AI 模型调用
         ├──► 回复生成
         └──► 回复发送
```

### 插件加载流程

```
插件发现
    │
    ▼
读取 plugin.json
    │
    ▼
检查依赖
    │
    ▼
选择适配器
    │
    ▼
加载插件代码
    │
    ▼
创建插件实例
    │
    ▼
调用 on_load
    │
    ▼
注册能力
    │
    ▼
调用 on_enable
    │
    ▼
插件就绪
```

### AI 回复流程

```
消息接收
    │
    ▼
消息预处理
    │
    ▼
记忆检索
    │
    ▼
上下文构建
    │
    ├──► 群组记忆
    ├──► 用户记忆
    └──► 会话记忆
    │
    ▼
AI 模型调用
    │
    ├──► 模型选择
    ├──► 提示词构建
    └──► 生成回复
    │
    ▼
回复后处理
    │
    ├──► 风格适配
    ├──► 内容优化
    └──► 表情选择
    │
    ▼
回复发送
    │
    ▼
记忆更新
```

## 核心机制

### 事件驱动机制

RuaBot 采用事件驱动架构，所有功能都通过事件进行通信：

1. **事件发布**: 系统或插件发布事件到事件总线
2. **事件订阅**: 插件或模块订阅感兴趣的事件
3. **事件处理**: 订阅者异步处理事件
4. **事件拦截**: 拦截器可以拦截和修改事件

### 插件生命周期

插件拥有完整的生命周期：

1. **发现**: 系统发现插件目录
2. **加载**: 加载插件代码和配置
3. **初始化**: 调用 `on_load` 钩子
4. **启用**: 调用 `on_enable` 钩子
5. **运行**: 插件正常运行
6. **禁用**: 调用 `on_disable` 钩子
7. **卸载**: 调用 `on_unload` 钩子

### 配置管理机制

配置管理支持多层级配置：

1. **默认配置**: 代码中的默认值
2. **配置文件**: TOML 配置文件
3. **环境变量**: 环境变量覆盖
4. **运行时配置**: 运行时动态配置

### 权限检查机制

权限检查采用链式检查：

1. **全局权限**: 检查全局权限设置
2. **群组权限**: 检查群组权限设置
3. **用户权限**: 检查用户权限设置
4. **工具权限**: 检查工具权限设置

### 记忆管理机制

记忆管理采用分层存储：

1. **会话记忆**: 当前会话的上下文
2. **用户记忆**: 用户级别的历史
3. **群组记忆**: 群组级别的历史
4. **全局记忆**: 全局共享的知识

## 数据流

### 消息数据流

```
OneBot 消息
    │
    ▼
消息解析
    │
    ▼
事件构建
    │
    ▼
事件总线
    │
    ├──► 插件处理
    └──► AI 处理
         │
         ├──► 消息记录
         ├──► 记忆检索
         ├──► AI 生成
         └──► 回复构建
              │
              ▼
         OneBot 回复
```

### 配置数据流

```
配置文件 (TOML)
    │
    ▼
配置解析
    │
    ▼
环境变量覆盖
    │
    ▼
配置对象
    │
    ├──► 缓存
    └──► 应用
```

### 插件数据流

```
插件目录
    │
    ├──► plugin.json (元数据)
    ├──► system.json (系统数据)
    └──► data/config.json (配置数据)
    │
    ▼
插件加载
    │
    ▼
插件实例
    │
    ├──► 注册能力
    ├──► 订阅事件
    └──► 提供服务
```

## 性能优化

### 异步处理

- 所有 I/O 操作都是异步的
- 事件处理采用异步机制
- 数据库操作采用异步 ORM

### 缓存机制

- 配置缓存
- 插件元数据缓存
- AI 配置缓存
- 记忆缓存

### 连接池

- 数据库连接池
- HTTP 连接池
- WebSocket 连接管理

### 资源管理

- 线程池管理
- 内存管理
- 文件句柄管理

## 扩展性设计

### 插件扩展

- 标准化的插件接口
- 灵活的适配器系统
- 完善的生命周期管理

### 协议扩展

- 支持协议扩展
- 支持自定义消息类型
- 支持自定义事件类型

### AI 扩展

- 支持多种 LLM 模型
- 支持自定义 AI 功能
- 支持自定义学习算法

## 安全性设计

### 认证授权

- Token 认证
- 会话管理
- 权限验证

### 数据安全

- 配置加密
- 敏感数据保护
- 审计日志

### 访问控制

- IP 白名单
- 频率限制
- 请求验证

